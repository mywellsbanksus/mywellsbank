(function($,window,document,undefined){var pluginName="WFTimer",defaults={isTimedOut:false,newLightBox:{},sessionTimerWhen:{},sessionTimerWarning:2000,sessionTimerTimedout:5000,useLightBox:true,continueUserSessionURL:"/as/global/session-reset",sessionTimeoutURL:"/as/global/session-timeout",siteSuffixElementID:"siteSuffix",lightBoxConfig:{lbOption:{noCloseButton:true},backDropName:"wf_timer_m_backdrop",closeButtonClass:"wf_timer_m_balloon-close",continueButtonID:"continueSessionBtn",cssLocationPath:"css/template/wftimer.css",triggerLinkId:"sessionTimeoutTrigger",popupContentId:"wf_timer_m_balloon-content",triggerLinkText:"Session TimeOut Trigger",targetContainerClass:"wf_timer_m_balloon-container"}};function WFTimer(element,options){this.element=element;this.settings=$.extend({},defaults,options);this._name=pluginName;this.init();}$.extend(WFTimer.prototype,{ajaxLog:function(err){var _=this;var url="/as/jsLog";var query={"message":err.message,"url":window.location.href,"logType":"FATAL","detailedMessage":{}};var detailedMessage={};if(err.fileName){detailedMessage.jsFileUrl=err.fileName;}else{if(err.sourceURL){detailedMessage.jsFileUrl=err.sourceURL;}}if(err.stack){var stack=_.parseErrorStack(err.stack);if(stack[0]){if(stack[0].name){detailedMessage.errorFunctionName=stack[0].name;}if(stack[0].line){detailedMessage.errorLineNumber=stack[0].line;}if(!query.jsFileUrl){detailedMessage.jsFileUrl=stack[0].url;}if(stack[0].args){detailedMessage.additionalInfo="arguments: "+stack[0].args;}}if(stack[1]&&stack[1].name){detailedMessage.callingFunctionName=stack[1].name;}}else{if(arguments.callee.caller){detailedMessage.errorFunctionName=this.getNameFromCallee(arguments.callee.caller);if(arguments.callee.caller.caller){detailedMessage.callingFunctionName=this.getNameFromCallee(arguments.callee.caller.caller);}}else{detailedMessage=JSON.stringify(arguments);}}if(err.line){detailedMessage.errorLineNumber=err.line;}query.detailedMessage=JSON.stringify(detailedMessage);if($.isEmptyObject(detailedMessage)||query.detailedMessage==="{}"){query.detailedMessage="Detailed message is empty at this time";}$.ajax({type:"POST",data:JSON.stringify(query),url:url,contentType:"application/json"});},continueUserSession:function(evt){this.settings.newLightBox.hidewf_timer_m_balloon();$("."+this.settings.lightBoxConfig.targetContainerClass).hide().html("");this.resetSession();},resetSession:function(){var _=this;var suff="",siteSuffixElementID="#"+this.settings.siteSuffixElementID;if(siteSuffixElementID!==undefined){suff="siteSuffix="+$(siteSuffixElementID).val();}$.ajax({"type":"post","url":_.settings.continueUserSessionURL,"data":suff,"success":function(data){data=_.untaintAndParse(data);try{if(hasError(data)){handleAjaxError(data);return;}if(data.warningMessage){showMessageBox("warning",data.warningMessage);}else{if(data.informationalMessage){showMessageBox("info",data.informationalMessage);}}}catch(err){_.ajaxLog(err);}},"error":function(xhr,code,status){_.ajaxLog({"message":"AJAX request to "+_.settings.continueUserSessionURL+" failed with: "+code+" "+xhr.status+" "+xhr.statusText});}});this.setSessionTimer();},createContainerElement:function(){if(this.settings.lightBoxConfig.cssLocationPath!==undefined&&this.settings.lightBoxConfig.cssLocationPath.length>0){var cssNode='<link rel="stylesheet" href="'+this.settings.lightBoxConfig.cssLocationPath+'" >';$("head").append(cssNode);}if($("."+this.settings.lightBoxConfig.targetContainerClass).length<1){var containerElement='<div id="'+this.settings.lightBoxConfig.targetContainerClass+'" class="'+this.settings.lightBoxConfig.targetContainerClass+'"></div>';$(this.element).append(containerElement);}},getContinueSessionHTML:function(expTime){return"<div class='"+this.settings.lightBoxConfig.popupContentId+"' aria-hidden='false'>  "+"<span class='ui-hidden-accessible wf_timer_m_begin'>Begin popup</span>  "+"<div id='content'><h1 class='Page_title'>Do you want to continue your session?</h1>  "+"<div class='editSubTitle Body_text'>For security reasons, your session will time out at  "+" "+this.getFormattedTime(expTime)+" unless you continue.</div>  "+"<button class='wf_timer_m_submit' id='"+this.settings.lightBoxConfig.continueButtonID+"'>  "+"Continue Session</button></div>  "+"<span class='ui-hidden-accessible'>End popup</span></div>";},getFormattedTime:function(dt){var hr=dt.getHours();var min=""+dt.getMinutes();var meridiem="AM";if(hr>11){meridiem="PM";}if(hr>12){hr-=12;}if(hr<1){hr=12;}if(min.length==1){min="0"+min;}var tz=dt.toString().match(/((Eastern|Central|Mountain|Pacific) (Daylight|Standard) Time|[ECMP][DS]T)/);if(tz){tz=" "+tz[0].replace(/[a-z ]/g,"");}else{tz="";}return hr+":"+min+" "+meridiem;},getNameFromCallee:function(callee){var hope=callee.toString().match(/^function (\w*)\(/);if(hope&&hope[1]){return hope[1];}if(callee.toString().search(/^function ?\(/)!=-1){return"[anonymous function]";}return false;},getTimedOutHTML:function(expTime){return"<div class='"+this.settings.lightBoxConfig.popupContentId+"' aria-hidden='false'>  "+"<span class='ui-hidden-accessible'>Begin popup</span>  "+"<div id='content'><h1 class='Page_title'>Session Timed Out</h1>  "+"<div class='editSubTitle Body_text'>Your session has timed out</div>  "+"<span class='ui-hidden-accessible'>End popup</span></div>";},handleNoLightBox:function(){},hasError:function(json){if(json&&json.redirectUrl){return json.redirectUrl;}if(json&&json.status=="error"){if(json.errorMessage){return json.errorMessage;}if(json.errorText){return json.errorText;}if(json.data&&json.data.invalidFields){return true;}}if(json&&json.status=="failed"){return true;}return false;},init:function(){this.setSessionTimer();},initTriggerLink:function(){this.settings.$popupTriggerLink=$("<a />").attr("id",this.settings.lightBoxConfig.triggerLinkId).addClass(this.settings.lightBoxConfig.triggerLinkId).attr("data-lbcontentId",this.settings.lightBoxConfig.popupContentId).text(this.settings.lightBoxConfig.triggerLinkText);$("."+this.settings.lightBoxConfig.targetContainerClass).show();$("#"+this.settings.lightBoxConfig.targetContainerClass).append(this.settings.$popupTriggerLink);$("."+this.settings.lightBoxConfig.targetContainerClass).append(this.settings.lightBoxConfig.popupContentHtml);$(document.body).append("<div id='"+this.settings.lightBoxConfig.backDropName+"' class='"+this.settings.lightBoxConfig.backDropName+"'></div>");$("#"+this.settings.lightBoxConfig.popupContentId).hide();$(this.settings.$popupTriggerLink).hide();},parseErrorStack:function(stack,errName){var isChrome=(stack.search(/\n +at/)!=-1);stack=stack.replace(/(\d+):\d+\)\n/g,"$1\n");var lines=stack.split(/\n(?: +at )?/);if(isChrome){lines.shift();}var ret=[],funcname;for(var i=0;i<lines.length;i++){var item={};if(isChrome){funcname=lines[i].split(/ /).shift();}else{funcname=lines[i].split(/\@/).shift();}var match=funcname.match(/\((.*)\)$/);if(match){item.args=match[1];funcname=funcname.substr(0,funcname.indexOf("("));}item.name=funcname;item.line=lines[i].split(/:/).pop();lines[i]=lines[i].replace(/:\d+$/,"");item.url=lines[i].split(/[\(@]/).pop();ret.push(item);}return ret;},setSessionTimer:function(){var timeoutHandler;var _=this;clearTimeout(window.sessionTimerWarning);clearTimeout(window.sessionTimerTimedout);this.createContainerElement();if(!this.settings.isTimedOut){if(this.settings.useLightBox!==undefined&&this.settings.useLightBox===true){timeoutHandler=function(){_.settings.lightBoxConfig.bindEventsToButton=[{buttonId:_.settings.lightBoxConfig.continueButtonID,handlerFunc:_.continueUserSession,exitPopupAfterProcessing:true}];_.settings.lightBoxConfig.popupContentHtml=_.getContinueSessionHTML(_.settings.sessionTimerWhen);_.showLightBox();};}else{timeoutHandler=this.handleNoLightBox;}window.sessionTimerWarning=setTimeout(function(){timeoutHandler(_.settings.sessionTimerWhen);},this.settings.sessionTimerWarning);window.sessionTimerTimedout=setTimeout(function(){_.showTimeoutPage();},this.settings.sessionTimerTimedout);
}},showLightBox:function(){this.initTriggerLink();var _=this;var lid=$("."+this.settings.lightBoxConfig.triggerLinkId);this.settings.newLightBox=new this.wf_timer_m_balloon(lid[0],this.settings.lightBoxConfig);this.settings.newLightBox.init();$("#"+this.settings.lightBoxConfig.continueButtonID).on("click",function(){_.continueUserSession();});$("."+this.settings.lightBoxConfig.closeButtonClass).on("click",function(){_.continueUserSession();});$(this.settings.$popupTriggerLink[0]).trigger("click").hide();},showTimeoutPage:function(){this.settings.isTimedOut=true;var targetContainer="."+this.settings.lightBoxConfig.targetContainerClass;$(targetContainer).html(" ");this.settings.lightBoxConfig.popupContentHtml=this.getTimedOutHTML();$(targetContainer).append(this.getTimedOutHTML());window.location.href=this.settings.sessionTimeoutURL;},untaintAndParse:function(str){var _=this;if(str.substr(0,100).search(/for *\(;;/)==-1){_.ajaxLog({"message":"Expected JSON result but got: "+str.substr(0,100)+"..."});return str;}try{str=str.replace(/^\s*for *\(;;\) *;?\s*/,"");str=str.replace(/^\s*\/\*\s*\w+%\s+\{/,"{").replace(/\}\s+%\w+\s*\*\/\s*$/,"}");return jQuery.parseJSON(str);}catch(err){_.ajaxLog(err);}},wf_timer_m_balloon:function(balloonHelp,options){var self=this;var $balloonHelp=$(balloonHelp);var loaded=false,dynamic=false,helperDialog=$("<div/>"),$balloonBackDrop=$("#"+options.backDropName),$balloonClose,$balloonContentID,$balloonContent,$linkID=$balloonHelp.id,$options=options,lastWindowWidth=$(window).width(),lastWindowHeight=$(window).height(),smallDelay;this.$balloonHelpContentID=$balloonHelp.data("lbcontentid");this.generateUniqueId=function(elem){var id="";while(elem.tagName!="BODY"){id=($(elem).prevAll().length+1)+"_"+id;if(!elem.parentNode){var arr="0123456789abcdef".split("");for(var i=0;i<16;i++){id+=arr[Math.floor(Math.random()*arr.length)];}break;}elem=elem.parentNode;}return"NID"+id.substr(0,id.length-1);};this.init=function(){var dat=$balloonHelp.data();var updateCallback=this.updateLayout;lastWindowWidth=$(window).width();lastWindowHeight=$(window).height();if(dat["lbcontentid"]){$balloonContentID=dat["lbcontentid"];$balloonContent=$("."+$balloonContentID);$balloonContent.appendTo("."+$options.targetContainerClass);self.createwf_timer_m_balloon($balloonContent);self.showwf_timer_m_balloon($balloonContent);self.loaded=true;}$(window).on("resize",function(){if($(window).width()!==lastWindowWidth||$(window).height()!==lastWindowHeight){window.clearTimeout(smallDelay);smallDelay=window.setTimeout(function(){updateCallback();},400);}});updateCallback();};this.updateLayout=function(){var container=$("."+$options.targetContainerClass);var newY=(lastWindowHeight/2)-(container.height()/2);var diffHeight=lastWindowHeight-container.height();};this.setUpDynamicwf_timer_m_balloon=function(content){if(!self.loaded){if(!$balloonHelp.id){$balloonHelp.id=this.generateUniqueId($balloonHelp);}$balloonContentID="wf_timer_m_dynamic-balloon-content-"+$balloonHelp.id;$('<div id="'+$balloonContentID+'" class="'+$options.popupContentId+'" role="region" aria-hidden="true" />').appendTo($("body"));$balloonContent=$("#"+$balloonContentID);$balloonContent.append(content.contents().clone(true));self.dynamic=true;self.createwf_timer_m_balloon();self.loaded=true;}self.showwf_timer_m_balloon();};this.showErrorDialog=function(XMLHttpRequest,textStatus,errorThrown){if(!$("#errorContent").length){$('<div id="errorContent" class="'+$options.popupContentId+'" role="region" aria-hidden="true" />').appendTo($("body"));}$balloonContent=$("#errorContent");$balloonContent.empty();$balloonContent.html("<h2>Error Encountered</h2>");$balloonContent.append("<div>"+XMLHttpRequest.status+"</div>");$balloonContent.append("<div>"+errorThrown+"</div>");self.createwf_timer_m_balloon();self.showwf_timer_m_balloon();self.loaded=false;};this.createwf_timer_m_balloon=function(){if(!self.loaded){$balloonContent.prepend($('<img src="'+assetsBasePath+'/assets/images/global/btn-close-x.png" class="wf_timer_m_balloon-close" alt="close"/>'));$balloonContent.prepend($('<span class="ui-hidden-accessible wf_timer_m_begin">Begin popup</span>'));$balloonClose=$balloonContent.find("."+$options.closeButtonClass);$('<span class="ui-hidden-accessible">End popup</span>').appendTo($balloonContent);if($options.lbOption.noCloseButton){$(".wf_timer_m_balloon-close").addClass("noCloseButton");}$($balloonBackDrop).on("click",function(evt){evt.preventDefault();evt.stopPropagation();if(typeof clearErrorMarkers==="function"){clearErrorMarkers();}if(options.closeOnBalloonBackDropClick===true){self.hidewf_timer_m_balloon();}});}};this.showwf_timer_m_balloon=function(){$balloonBackDrop.removeClass("wf_timer_m_balloon-fadeout-hidden").addClass("wf_timer_m_balloon-fadein");$balloonContent.removeClass("wf_timer_m_balloon-fadeout-hidden").addClass("wf_timer_m_balloon-fadein").attr("aria-hidden","false");$("div#shell").attr("aria-hidden","true");$balloonContent.find("h1.Page_title").attr("tabindex",0).focus();};this.hidewf_timer_m_balloon=function(){$balloonContent.addClass("wf_timer_m_balloon-fadeout").removeClass("wf_timer_m_balloon-fadein").attr("aria-hidden","true");$balloonBackDrop.removeClass("wf_timer_m_balloon-fadein").addClass("wf_timer_m_balloon-fadeout");setTimeout(function(){$balloonContent.removeClass("wf_timer_m_balloon-fadeout").addClass("wf_timer_m_balloon-fadeout-hidden");$balloonBackDrop.removeClass("wf_timer_m_balloon-fadeout").addClass("wf_timer_m_balloon-fadeout-hidden");},700);$balloonContent.find("h1.Page_title").removeAttr("tabindex");$("div#shell").attr("aria-hidden","false");$balloonHelp.focus();};this.getOptionsFromLink=function(){if(typeof balloonHelp.href!="undefined"&&balloonHelp.href.indexOf("?")!=-1){options.url=balloonHelp.href.substr(0,balloonHelp.href.indexOf("?"));var params=balloonHelp.href.substr(balloonHelp.href.indexOf("?")+1);params=params.split(/&(?:amp;)?/);$.each(params,function(idx,param){var p=param.split("=");options.parameters[p[0]]=p[1];});options.method="GET";}else{options.url=balloonHelp.href;}};this.handleAjaxResponse=function(data){var content=self.getContentRegion(data);self.setUpDynamicwf_timer_m_balloon(content);};this.getContentRegion=function(data){data="<div>"+data+"</div>";var content=$(data).find("#content");if(!content.length){content=$(data).find(".mainContentCol:first");}return content;};this.requestContent=function(){if(!self.loaded){$.ajax({async:false,url:options.url,type:options.method,data:options.parameters,timeout:options.timeout,error:function(XMLHttpRequest,textStatus,errorThrown){self.showErrorDialog(XMLHttpRequest,textStatus,errorThrown);return false;},success:function(data){self.handleAjaxResponse(data);}});}else{self.setUpDynamicwf_timer_m_balloon();}};if(typeof balloonHelp.href!="undefined"&&balloonHelp.href!=""){self.getOptionsFromLink();}}});$.fn[pluginName]=function(options){return this.each(function(){if(!$.data(this,"plugin_"+pluginName)){$.data(this,"plugin_"+pluginName,new WFTimer(this,options));}});};})(jQuery,window,document);